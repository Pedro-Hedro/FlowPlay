name: Terraform GitFlow Deploy

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'

  pull_request:
    branches:
      - main
      - develop

jobs:
  # terraform-lint:
  #   name: Lint and Security Checks
  #   runs-on: ubuntu-latest

  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v2

  #   - name: Setup Terraform
  #     uses: hashicorp/setup-terraform@v3.1.0
  #     with:
  #       terraform_version: 1.4.6

  #   - name: Install tfsec manually
  #     run: |
  #         set +u
  #         wget https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64 -O /usr/local/bin/tfsec
  #         chmod +x /usr/local/bin/tfsec

  #   # Run tfsec for security analysis
  #   - name: Run tfsec
  #     run: tfsec ./terraform
  #     continue-on-error: true

  #   # Install Checkov for additional security scanning
  #   - name: Install Checkov
  #     run: |
  #       pip install checkov
  #     continue-on-error: true

  #   # Run Checkov for code checks and security
  #   - name: Run Checkov
  #     run: checkov -d ./terraform
  #     continue-on-error: true

  terraform-plan:
    name: Terraform Plan (Dev or Prod)
    runs-on: ubuntu-latest
    #needs: terraform-lint

    steps:
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.1.0

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: ./terraform

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -input=false tfplan
        working-directory: ./terraform